<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diff Master v6.0 (Auto-Switch & Sync Control)</title>
    <style>
        :root {
            --bg-body: #f4f6f8; --bg-panel: #ffffff; --border: #d0d7de;
            --text-main: #24292f; --text-sub: #57606a; --primary: #0969da;
            --del-bg: #ffebe9; --del-text: #cf222e;
            --ins-bg: #dafbe1; --ins-text: #1a7f37;
            --hl-focus: #fffbdd;
        }

        [data-theme="dark"] {
            --bg-body: #0d1117; --bg-panel: #161b22; --border: #30363d;
            --text-main: #c9d1d9; --text-sub: #8b949e; --primary: #58a6ff;
            --del-bg: #4b1a1f; --del-text: #ff7b72;
            --ins-bg: #153621; --ins-text: #3fb950;
            --hl-focus: #4e4012;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); overflow: hidden; }

        /* Header */
        header { height: 50px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 10; }
        h1 { font-size: 16px; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .toolbar { display: flex; gap: 8px; align-items: center; }

        .btn { padding: 4px 10px; border: 1px solid var(--border); background: var(--bg-panel); border-radius: 4px; cursor: pointer; font-size: 12px; color: var(--text-main); display: flex; align-items: center; gap: 4px; transition: all 0.2s; user-select: none; }
        .btn:hover { background: var(--bg-body); border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0); box-shadow: none; }
        .btn.active { background: rgba(9, 105, 218, 0.1); border-color: var(--primary); color: var(--primary); font-weight: 600; }
        
        .toggle-group { display: flex; background: var(--bg-body); border: 1px solid var(--border); border-radius: 4px; padding: 2px; }
        .toggle-opt { padding: 3px 10px; cursor: pointer; border-radius: 3px; font-size: 12px; color: var(--text-sub); transition: all 0.2s; }
        .toggle-opt.active { background: var(--bg-panel); color: var(--text-main); font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; }
        .input-col { flex: 4; display: flex; flex-direction: column; border-right: 1px solid var(--border); background: var(--bg-panel); min-width: 300px; }
        .output-col { flex: 5; display: flex; flex-direction: column; background: var(--bg-panel); min-width: 300px; }

        /* Input Boxes */
        .input-wrapper { flex: 1; position: relative; display: flex; flex-direction: column; }
        .input-wrapper:first-child { border-bottom: 1px solid var(--border); }
        .label {
            position: absolute; top: 0; left: 0; right: 0; height: 24px; background: var(--bg-body); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 10px;
            font-size: 11px; font-weight: 700; color: var(--text-sub); z-index: 5; pointer-events: none;
        }
        .action-link { pointer-events: auto; cursor: pointer; color: var(--primary); }
        
        textarea {
            flex: 1; width: 100%; border: none; resize: none; padding: 30px 10px 10px 10px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; font-size: 12px; line-height: 1.5;
            color: var(--text-main); background: var(--bg-panel);
        }
        
        /* Drag Overlay */
        .drag-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(9, 105, 218, 0.05);
            display: none; align-items: center; justify-content: center; font-size: 14px; color: var(--primary); font-weight: bold; pointer-events: none; z-index: 10;
        }
        .input-wrapper.drag-over .drag-overlay { display: flex; }

        /* Output & Status */
        .status-bar { height: 32px; background: var(--bg-body); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; font-size: 12px; color: var(--text-sub); }
        #diff-view { flex: 1; padding: 0; overflow-y: auto; font-family: "SFMono-Regular", Consolas, Menlo, monospace; font-size: 12px; line-height: 1.6; white-space: pre-wrap; word-break: break-all; position: relative; }
        
        /* è¡Œæ ·å¼ */
        .diff-line { display: flex; min-height: 1.6em; }
        .diff-line-content { flex: 1; padding: 0 15px; }
        .diff-line.has-change { background: rgba(9, 105, 218, 0.02); }
        
        /* æŠ˜å ä¸Šä¸‹æ–‡ */
        .context-fold { 
            text-align: center; padding: 5px 0; cursor: pointer; 
            background: var(--bg-body); color: var(--text-sub); 
            border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
            font-size: 11px; user-select: none;
            transition: all 0.2s;
        }
        .context-fold:hover { background: var(--bg-panel); color: var(--primary); }
        .context-fold.collapsed { border-top: none; }
        .context-lines { overflow: hidden; transition: max-height 0.3s ease; }
        .context-lines.collapsed { max-height: 0; }
        
        del { background: var(--del-bg); color: var(--del-text); text-decoration: line-through; border-bottom: 1px solid rgba(255,0,0,0.1); }
        ins { background: var(--ins-bg); color: var(--ins-text); text-decoration: none; border-bottom: 1px solid rgba(0,255,0,0.1); }
        .highlight-focus { background: var(--hl-focus); box-shadow: 0 0 0 2px var(--hl-focus); border-radius: 2px; }
        
        /* é€‰é¡¹ç»„æ ·å¼ */
        .options-group { display: flex; gap: 8px; align-items: center; }
        .option-checkbox { display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 11px; color: var(--text-sub); }
        .option-checkbox input[type="checkbox"] { cursor: pointer; }
        .option-checkbox:hover { color: var(--text-main); }
        .empty-tip { color: #8c959f; text-align: center; margin-top: 20%; }
        .error-msg { color: #cf222e; background: #ffebe9; padding: 10px; border-radius: 6px; border: 1px solid rgba(207,34,46,0.2); text-align: center; margin-top: 20px; }

        /* Print */
        @media print {
            body { height: auto; overflow: visible; background: #fff; }
            header, .input-col, .status-bar { display: none !important; }
            .container, .output-col, #diff-view { display: block; height: auto; overflow: visible; width: 100%; border: none; }
            #diff-view { padding: 0; }
        }
    </style>
</head>
<body>

<header>
    <h1>âš–ï¸ Diff Master v6</h1>
    <div class="toolbar">
        <button class="btn" id="syncBtn" onclick="App.toggleSync()" title="å¼€å¯/å…³é—­æ»šåŠ¨åŒæ­¥">ğŸ”— åŒæ­¥æ»šåŠ¨</button>
        <div style="width:1px; height:16px; background:var(--border); margin:0 4px;"></div>
        <div class="toggle-group" id="modeSwitch">
            <div class="toggle-opt active" data-mode="char">é€å­—</div>
            <div class="toggle-opt" data-mode="smart">æ™ºèƒ½</div>
        </div>
        <div style="width:1px; height:16px; background:var(--border); margin:0 4px;"></div>
        <div class="options-group">
            <label class="option-checkbox" title="å¿½ç•¥ç©ºç™½å­—ç¬¦">
                <input type="checkbox" id="ignoreWhitespace" onchange="App.run('manual')">
                <span>å¿½ç•¥ç©ºç™½</span>
            </label>
            <label class="option-checkbox" title="å¿½ç•¥å¤§å°å†™">
                <input type="checkbox" id="ignoreCase" onchange="App.run('manual')">
                <span>å¿½ç•¥å¤§å°å†™</span>
            </label>
        </div>
        <div style="width:1px; height:16px; background:var(--border); margin:0 4px;"></div>
        <button class="btn" id="foldContextBtn" onclick="App.toggleFoldContext()" title="æŠ˜å /å±•å¼€æœªå˜æ›´å†…å®¹">ğŸ“¦ æŠ˜å ä¸Šä¸‹æ–‡</button>
        <button class="btn" onclick="App.toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“ ä¸»é¢˜</button>
        <button class="btn" onclick="App.clearAll()" title="æ¸…ç©ºå…¨éƒ¨">ğŸ—‘ï¸ é‡ç½®</button>
    </div>
</header>

<div class="container">
    <div class="input-col">
        <div class="input-wrapper" id="dropZoneOld">
            <div class="label">
                <span>åŸæ–‡ (æ‹–æ‹½æ–‡ä»¶)</span>
                <span class="action-link" onclick="App.clear('old')">æ¸…ç©º</span>
            </div>
            <div class="drag-overlay">ğŸ“‚ é‡Šæ”¾æ–‡ä»¶ä»¥è¯»å–</div>
            <textarea id="oldText" spellcheck="false" placeholder="ç²˜è´´æˆ–æ‹–å…¥æ–‡ä»¶..."></textarea>
        </div>
        <div class="input-wrapper" id="dropZoneNew">
            <div class="label">
                <span>ä¿®æ”¹å (æ‹–æ‹½æ–‡ä»¶)</span>
                <span class="action-link" onclick="App.clear('new')">æ¸…ç©º</span>
            </div>
            <div class="drag-overlay">ğŸ“‚ é‡Šæ”¾æ–‡ä»¶ä»¥è¯»å–</div>
            <textarea id="newText" spellcheck="false" placeholder="ç²˜è´´æˆ–æ‹–å…¥æ–‡ä»¶..."></textarea>
        </div>
    </div>

    <div class="output-col">
        <div class="status-bar">
            <div id="statsInfo">å‡†å¤‡å°±ç»ª</div>
            <div style="display:flex; gap:4px;">
                <button class="btn" onclick="App.navDiff(-1)">â–²</button>
                <button class="btn" onclick="App.navDiff(1)">â–¼</button>
            </div>
        </div>
        <div id="diff-view"><div class="empty-tip">ç­‰å¾…è¾“å…¥...</div></div>
    </div>
</div>

<script>
const App = {
    mode: 'char', // é»˜è®¤æ¨¡å¼
    syncEnabled: false, // é»˜è®¤ä¸å¼€å¯åŒæ­¥
    ignoreWhitespace: false, // å¿½ç•¥ç©ºç™½å­—ç¬¦
    ignoreCase: false, // å¿½ç•¥å¤§å°å†™
    foldContextEnabled: false, // æ˜¯å¦æŠ˜å æœªå˜æ›´ä¸Šä¸‹æ–‡
    contextLines: 3, // ä¸Šä¸‹æ–‡è¡Œæ•°
    
    diffChunks: [],
    currentChunkIdx: -1,
    timer: null,
    isSyncing: false, // é˜²æ­¢æ»šåŠ¨åŒæ­¥å¾ªç¯
    // é˜ˆå€¼ï¼š1.5äº¿ (çº¦ç­‰äº 12000å­— x 12000å­—)ï¼Œè¶…è¿‡åˆ™è­¦å‘Šæˆ–è‡ªåŠ¨é™çº§
    MAX_CHAR_COMPLEXITY: 150000000,
    // æœ€å¤§æ–‡ä»¶å¤§å°ï¼š10MB
    MAX_FILE_SIZE: 10 * 1024 * 1024, 
    
    init() {
        this.dom = {
            old: document.getElementById('oldText'),
            new: document.getElementById('newText'),
            view: document.getElementById('diff-view'),
            stats: document.getElementById('statsInfo'),
            modeSwitch: document.getElementById('modeSwitch'),
            syncBtn: document.getElementById('syncBtn'),
            foldContextBtn: document.getElementById('foldContextBtn'),
            ignoreWhitespace: document.getElementById('ignoreWhitespace'),
            ignoreCase: document.getElementById('ignoreCase')
        };

        // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼ˆé˜²æŠ–ï¼‰
        // è¿™é‡Œä¼ é€’ 'input' æ ‡è®°ï¼Œè¡¨ç¤ºæ˜¯è‡ªåŠ¨è§¦å‘çš„ï¼Œå…è®¸è‡ªåŠ¨é™çº§
        ['input', 'change'].forEach(e => {
            this.dom.old.addEventListener(e, () => this.scheduleRun('input'));
            this.dom.new.addEventListener(e, () => this.scheduleRun('input'));
        });

        // æ‹–æ‹½æ”¯æŒ
        this.setupDrag('dropZoneOld', 'oldText');
        this.setupDrag('dropZoneNew', 'newText');

        // ä¸‰çª—å£åŒæ­¥æ»šåŠ¨
        const syncAll = (src) => {
            if (!this.syncEnabled || this.isSyncing) return;
            // ç§»åŠ¨ç«¯ä½¿ç”¨ pointer-events æ£€æŸ¥ï¼Œæ¡Œé¢ç«¯ä½¿ç”¨ hover
            const isActive = src.matches(':hover') || 
                            (window.matchMedia('(pointer: fine)').matches && document.activeElement === src) ||
                            src.matches(':focus-within');
            if (isActive) {
                this.isSyncing = true;
                const pct = src.scrollTop / (src.scrollHeight - src.clientHeight || 1);
                
                // åŒæ­¥åˆ°å…¶ä»–ä¸¤ä¸ªçª—å£
                const targets = [this.dom.old, this.dom.new, this.dom.view].filter(t => t !== src);
                targets.forEach(target => {
                    target.scrollTop = pct * (target.scrollHeight - target.clientHeight || 1);
                });
                
                requestAnimationFrame(() => { this.isSyncing = false; });
            }
        };
        this.dom.old.addEventListener('scroll', () => syncAll(this.dom.old));
        this.dom.new.addEventListener('scroll', () => syncAll(this.dom.new));
        this.dom.view.addEventListener('scroll', () => syncAll(this.dom.view));

        // æ¨¡å¼åˆ‡æ¢
        this.dom.modeSwitch.querySelectorAll('.toggle-opt').forEach(el => {
            el.addEventListener('click', (e) => {
                // æ‰‹åŠ¨ç‚¹å‡»åˆ‡æ¢æ¨¡å¼
                const newMode = e.target.dataset.mode;
                this.setMode(newMode);
                // å¼ºåˆ¶ç«‹å³æ‰§è¡Œï¼Œä¸”æ ‡è®°ä¸º 'manual'ï¼Œè¡¨ç¤ºç”¨æˆ·å¼ºåˆ¶è¦æ±‚è¯¥æ¨¡å¼
                this.run('manual');
            });
        });

        // è‡ªåŠ¨æ·±è‰²æ¨¡å¼
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            this.toggleTheme();
        }
    },

    setupDrag(zoneId, inputId) {
        const zone = document.getElementById(zoneId);
        const input = document.getElementById(inputId);
        
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > this.MAX_FILE_SIZE) {
                this.dom.stats.innerText = `æ–‡ä»¶è¿‡å¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œæœ€å¤§æ”¯æŒ 10MB`;
                this.dom.view.innerHTML = `<div class="error-msg">âš ï¸ æ–‡ä»¶è¿‡å¤§ï¼Œæ— æ³•åŠ è½½ã€‚<br>æ–‡ä»¶å¤§å°: ${(file.size / 1024 / 1024).toFixed(1)}MBï¼Œæœ€å¤§æ”¯æŒ: ${(this.MAX_FILE_SIZE / 1024 / 1024)}MB</div>`;
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡æœ¬æ–‡ä»¶ï¼ˆå¯é€‰ï¼šä»…æç¤ºï¼Œä¸å¼ºåˆ¶ï¼‰
            const textTypes = ['text/', 'application/json', 'application/xml', 'application/javascript'];
            const isTextFile = textTypes.some(t => file.type.startsWith(t)) || 
                             !file.type || // æ— ç±»å‹ä¹Ÿå…è®¸
                             file.name.match(/\.(txt|md|js|json|xml|html|css|py|java|c|cpp|h|hpp|log|csv|tsv|sh|bat|cmd|ps1)$/i);
            
            if (!isTextFile) {
                // éæ–‡æœ¬æ–‡ä»¶ç»™å‡ºè­¦å‘Šï¼Œä½†å…è®¸å°è¯•è¯»å–
                this.dom.stats.innerText = 'âš ï¸ æ£€æµ‹åˆ°éæ–‡æœ¬æ–‡ä»¶ï¼Œå¯èƒ½æ— æ³•æ­£ç¡®æ˜¾ç¤º';
            }
            
            const reader = new FileReader();
            reader.onerror = () => {
                this.dom.view.innerHTML = `<div class="error-msg">âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ${reader.error?.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                this.dom.stats.innerText = 'æ–‡ä»¶è¯»å–å¤±è´¥';
            };
            reader.onload = (ev) => {
                try {
                    input.value = ev.target.result;
                    this.run('input'); // æ‹–æ‹½è§†ä¸ºè‡ªåŠ¨è¾“å…¥
                } catch (err) {
                    this.dom.view.innerHTML = `<div class="error-msg">âŒ å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: ${err.message}</div>`;
                    this.dom.stats.innerText = 'å¤„ç†å¤±è´¥';
                }
            };
            reader.readAsText(file);
        });
    },

    toggleSync() {
        this.syncEnabled = !this.syncEnabled;
        if (this.syncEnabled) {
            this.dom.syncBtn.classList.add('active');
            this.dom.syncBtn.innerHTML = 'ğŸ”— åŒæ­¥å¼€å¯';
        } else {
            this.dom.syncBtn.classList.remove('active');
            this.dom.syncBtn.innerHTML = 'ğŸ”— åŒæ­¥æ»šåŠ¨';
        }
    },
    
    toggleFoldContext() {
        this.foldContextEnabled = !this.foldContextEnabled;
        if (this.foldContextEnabled) {
            this.dom.foldContextBtn.classList.add('active');
            this.dom.foldContextBtn.innerHTML = 'ğŸ“¦ æŠ˜å å¼€å¯';
        } else {
            this.dom.foldContextBtn.classList.remove('active');
            this.dom.foldContextBtn.innerHTML = 'ğŸ“¦ æŠ˜å ä¸Šä¸‹æ–‡';
        }
        // é‡æ–°æ¸²æŸ“ä»¥åº”ç”¨æŠ˜å 
        const text1 = this.dom.old.value;
        const text2 = this.dom.new.value;
        if (text1 && text2) {
            this.run('manual');
        }
    },

    setMode(mode) {
        this.mode = mode;
        this.dom.modeSwitch.querySelectorAll('.toggle-opt').forEach(o => {
            if (o.dataset.mode === mode) o.classList.add('active');
            else o.classList.remove('active');
        });
    },

    clear(target) {
        if(target === 'old') this.dom.old.value = '';
        if(target === 'new') this.dom.new.value = '';
        this.dom.view.innerHTML = '<div class="empty-tip">å·²æ¸…ç©ºï¼Œç­‰å¾…è¾“å…¥...</div>';
        this.dom.stats.innerText = 'å·²æ¸…ç©º';
    },

    clearAll() {
        this.dom.old.value = '';
        this.dom.new.value = '';
        this.dom.view.innerHTML = '<div class="empty-tip">ç­‰å¾…è¾“å…¥...</div>';
        this.dom.stats.innerText = 'å‡†å¤‡å°±ç»ª';
        this.diffChunks = [];
        this.currentChunkIdx = -1;
    },

    toggleTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
    },

    scheduleRun(source) {
        this.dom.stats.innerText = 'æ­£åœ¨è¾“å…¥...';
        clearTimeout(this.timer);
        this.timer = setTimeout(() => this.run(source), 500);
    },

    run(source = 'input') {
        // æ›´æ–°é€‰é¡¹çŠ¶æ€
        this.ignoreWhitespace = this.dom.ignoreWhitespace.checked;
        this.ignoreCase = this.dom.ignoreCase.checked;
        
        let text1 = this.dom.old.value;
        let text2 = this.dom.new.value;
        
        // åº”ç”¨å¯¹æ¯”é€‰é¡¹
        if (this.ignoreWhitespace) {
            text1 = text1.replace(/\s+/g, ' ').trim();
            text2 = text2.replace(/\s+/g, ' ').trim();
        }
        if (this.ignoreCase) {
            text1 = text1.toLowerCase();
            text2 = text2.toLowerCase();
        }

        if (!text1 && !text2) {
            this.dom.view.innerHTML = '<div class="empty-tip">ç­‰å¾…è¾“å…¥...</div>';
            this.dom.stats.innerText = 'å‡†å¤‡å°±ç»ª';
            return;
        }
        if (!text1 || !text2) {
            this.dom.stats.innerText = 'ç­‰å¾…å¦ä¸€ä¸ªæ–‡ä»¶...';
            return;
        }

        // --- ä¿®å¤ï¼šä½¿ç”¨åˆ†è¯åçš„é•¿åº¦è¿›è¡Œå‡†ç¡®æ£€æŸ¥ ---
        // å¦‚æœæ˜¯è‡ªåŠ¨è§¦å‘ ('input')ï¼Œä¸”æ–‡æœ¬è¿‡é•¿ï¼Œä¸”å½“å‰æ˜¯ 'char' æ¨¡å¼ -> è‡ªåŠ¨åˆ‡ä¸º 'smart'
        // å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ ('manual')ï¼Œä¸åˆ‡ï¼Œè®©å®ƒæ’å¢™æŠ¥é”™
        let estimatedCost;
        if (this.mode === 'char') {
            // charæ¨¡å¼ä¸‹ï¼Œtokensæ•°é‡ç­‰äºå­—ç¬¦æ•°é‡
            estimatedCost = text1.length * text2.length;
        } else {
            // smartæ¨¡å¼ä¸‹ï¼Œéœ€è¦å…ˆåˆ†è¯ä¼°ç®—
            const tokens1 = this.tokenize(text1);
            const tokens2 = this.tokenize(text2);
            estimatedCost = tokens1.length * tokens2.length;
        }
        
        if (source === 'input' && this.mode === 'char' && estimatedCost > this.MAX_CHAR_COMPLEXITY) {
            this.setMode('smart'); // è‡ªåŠ¨åˆ‡åˆ° UI å’Œ é€»è¾‘
            this.dom.stats.innerText = 'æ–‡æœ¬è¿‡é•¿ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢ä¸ºæ™ºèƒ½æ¨¡å¼';
            // ç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶å·²å˜æˆ smart æ¨¡å¼
        } else {
            this.dom.stats.innerText = 'è®¡ç®—ä¸­...';
        }

        setTimeout(() => {
            try {
                this._performDiff(text1, text2);
            } catch (e) {
                console.error(e);
                const errorMsg = e.message || String(e);
                const errorStack = e.stack ? `<br><small style="opacity:0.7; font-size:11px;">${e.stack.split('\n')[0]}</small>` : '';
                this.dom.view.innerHTML = `<div class="error-msg">âŒ å‘ç”Ÿé”™è¯¯: ${this.escapeHtml(errorMsg)}${errorStack}</div>`;
                this.dom.stats.innerText = `é”™è¯¯: ${errorMsg.substring(0, 30)}...`;
            }
        }, 10);
    },

    _performDiff(text1, text2) {
        // åˆ†è¯
        const tokens1 = this.tokenize(text1);
        const tokens2 = this.tokenize(text2);
        const complexity = tokens1.length * tokens2.length;

        // --- é€»è¾‘å‡çº§ï¼šæ‰‹åŠ¨æ¨¡å¼ä¸‹çš„ç†”æ–­æç¤º ---
        // å¦‚æœç”¨æˆ·å¼ºè¡Œåˆ‡åˆ° Charï¼Œä½†é•¿åº¦ä¾ç„¶è¶…æ ‡ï¼Œåˆ™æŠ¥é”™
        if (complexity > this.MAX_CHAR_COMPLEXITY) {
            const modeText = this.mode === 'char' ? 'é€å­—å¯¹æ¯”' : 'æ™ºèƒ½å¯¹æ¯”';
            this.dom.view.innerHTML = `
                <div class="error-msg">
                    âš ï¸ æ–‡æœ¬è¿‡é•¿ï¼Œæ— æ³•è¿›è¡Œ${modeText}ã€‚<br>
                    <span style="font-size:12px; opacity:0.8">å½“å‰è¿ç®—é‡: ${(complexity / 1000000).toFixed(1)}M (é˜ˆå€¼: ${this.MAX_CHAR_COMPLEXITY/1000000}M)</span><br>
                    <span style="font-size:11px; opacity:0.7">Tokenæ•°é‡: ${tokens1.length.toLocaleString()} Ã— ${tokens2.length.toLocaleString()}</span><br><br>
                    ${this.mode === 'char' ? `<button class="btn" style="margin:0 auto" onclick="App.setMode('smart'); App.run('manual')">åˆ‡æ¢å›æ™ºèƒ½æ¨¡å¼</button>` : ''}
                </div>
            `;
            this.dom.stats.innerText = 'è®¡ç®—ä¸­æ­¢ï¼šæ–‡æœ¬è¿‡é•¿';
            return;
        }

        // å†…å­˜ä½¿ç”¨è­¦å‘Šï¼ˆä½†ä¸é˜»æ­¢æ‰§è¡Œï¼‰
        const estimatedMemoryMB = (complexity * 4) / 1024 / 1024;
        if (estimatedMemoryMB > 50) {
            this.dom.stats.innerText = `è®¡ç®—ä¸­... (é¢„è®¡å†…å­˜: ${estimatedMemoryMB.toFixed(0)}MB)`;
        }

        const diffs = this.computeLCS_Optimized(tokens1, tokens2);
        // ä¼ é€’åŸå§‹æ–‡æœ¬ç”¨äºç»Ÿè®¡å’Œè¡Œå·æ˜¾ç¤º
        this.render(diffs, this.dom.old.value, this.dom.new.value);
    },

    tokenize(text) {
        // å¦‚æœå¿½ç•¥ç©ºç™½ï¼Œåœ¨åˆ†è¯æ—¶ä¹Ÿè¦è€ƒè™‘
        if (this.mode === 'char') {
            const chars = text.split('');
            if (this.ignoreWhitespace) {
                return chars.filter(c => c.trim().length > 0);
            }
            return chars;
        }
        // æ”¹è¿›çš„æ­£åˆ™ï¼šæ”¯æŒæ›´å¤šUnicodeå­—ç¬¦
        // åŒ¹é…ï¼šè‹±æ–‡æ•°å­—å•è¯ã€ä¸­æ—¥éŸ©å­—ç¬¦ã€å…¶ä»–Unicodeå­—æ¯ã€ç©ºç™½ã€å…¶ä»–å­—ç¬¦
        const tokens = text.match(/([a-zA-Z0-9_]+)|([\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af])|([\p{L}\p{M}]+)|(\s+)|([^\p{L}\p{M}\s]+)/gu) || [];
        if (this.ignoreWhitespace) {
            return tokens.filter(t => t.trim().length > 0);
        }
        return tokens;
    },

    computeLCS_Optimized(arr1, arr2) {
        const m = arr1.length;
        const n = arr2.length;
        const dp = new Uint32Array((m + 1) * (n + 1));

        for (let i = 1; i <= m; i++) {
            for (let j = 1; j <= n; j++) {
                const currentIdx = i * (n + 1) + j;
                if (arr1[i - 1] === arr2[j - 1]) {
                    const diagIdx = (i - 1) * (n + 1) + (j - 1);
                    dp[currentIdx] = dp[diagIdx] + 1;
                } else {
                    const upIdx = (i - 1) * (n + 1) + j;
                    const leftIdx = i * (n + 1) + (j - 1);
                    dp[currentIdx] = Math.max(dp[upIdx], dp[leftIdx]);
                }
            }
        }

        const diffs = [];
        let i = m, j = n;
        while (i > 0 || j > 0) {
            const currentIdx = i * (n + 1) + j;
            if (i > 0 && j > 0 && arr1[i - 1] === arr2[j - 1]) {
                diffs.push({ t: 'eq', v: arr1[i - 1] });
                i--; j--;
            } else {
                const upIdx = (i - 1) * (n + 1) + j;
                const leftIdx = i * (n + 1) + (j - 1);
                if (j > 0 && (i === 0 || dp[leftIdx] >= dp[upIdx])) {
                    diffs.push({ t: 'ins', v: arr2[j - 1] });
                    j--;
                } else {
                    diffs.push({ t: 'del', v: arr1[i - 1] });
                    i--;
                }
            }
        }
        return diffs.reverse();
    },

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },

    render(diffs, text1, text2) {
        let html = '';
        let chunkIndex = 0;
        this.diffChunks = [];
        let lastType = null;
        let buffer = '';
        
        // ç»Ÿè®¡ä¿¡æ¯
        let delChunks = 0;
        let insChunks = 0;
        let delChars = 0;
        let insChars = 0;

        const escape = (text) => text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]));

        const flush = (type, val) => {
            if (!val) return;
            const safe = escape(val);
            
            if (type === 'eq') {
                html += `<span>${safe}</span>`;
            } else {
                const id = `diff-${chunkIndex++}`;
                this.diffChunks.push(id);
                if (type === 'del') {
                    delChunks++;
                    delChars += val.length;
                    html += `<del id="${id}">${safe}</del>`;
                } else {
                    insChunks++;
                    insChars += val.length;
                    html += `<ins id="${id}">${safe}</ins>`;
                }
            }
        };

        // æ„å»ºåŸºç¡€diff HTML
        diffs.forEach(d => {
            if (d.t !== lastType && lastType !== null) {
                flush(lastType, buffer);
                buffer = '';
            }
            lastType = d.t;
            buffer += d.v;
        });
        flush(lastType, buffer);

        // æŒ‰è¡Œåˆ†å‰²HTMLï¼ˆç®€åŒ–æ–¹æ³•ï¼šæŒ‰\nåˆ†å‰²ï¼‰
        const htmlLines = html.split('\n');

        // æ„å»ºè¾“å‡ºï¼ˆæ”¯æŒæ‰‹åŠ¨æŠ˜å æœªå˜æ›´å†…å®¹ï¼‰
        const resultLines = [];
        let contextBuffer = [];
        let contextStart = -1;
        const foldThreshold = this.contextLines * 2;

        htmlLines.forEach((lineHtml, idx) => {
            const hasChange = lineHtml.includes('<del') || lineHtml.includes('<ins');
            const isPureContext = !hasChange && lineHtml.trim() !== '';
            
            if (isPureContext) {
                contextBuffer.push({ html: lineHtml, idx });
                if (contextStart < 0) contextStart = idx;
            } else {
                // æœ‰å˜æ›´æˆ–ç©ºè¡Œï¼Œå¤„ç†ä¸Šä¸‹æ–‡
                if (this.foldContextEnabled && contextBuffer.length > foldThreshold && contextStart >= 0) {
                    // éœ€è¦æŠ˜å ä¸Šä¸‹æ–‡ï¼ˆé»˜è®¤æŠ˜å ï¼‰
                    const contextId = `context-${contextStart}-${idx - 1}`;
                    const contextHtml = contextBuffer.map(l => {
                        return `<div class="diff-line"><div class="diff-line-content">${l.html || '&nbsp;'}</div></div>`;
                    }).join('');
                    
                    resultLines.push(
                        `<div class="context-fold collapsed" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed')">
                            <span>â‹¯ ${contextBuffer.length} è¡Œæœªå˜æ›´å†…å®¹ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</span>
                        </div>
                        <div class="context-lines collapsed" id="${contextId}">${contextHtml}</div>`
                    );
                    contextBuffer = [];
                    contextStart = -1;
                } else if (contextBuffer.length > 0) {
                    // ç›´æ¥æ˜¾ç¤ºä¸Šä¸‹æ–‡ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰
                    contextBuffer.forEach(l => {
                        resultLines.push(`<div class="diff-line"><div class="diff-line-content">${l.html || '&nbsp;'}</div></div>`);
                    });
                    contextBuffer = [];
                    contextStart = -1;
                }

                // æ·»åŠ å½“å‰è¡Œ
                const lineClass = hasChange ? 'has-change' : '';
                resultLines.push(`<div class="diff-line ${lineClass}"><div class="diff-line-content">${lineHtml || '&nbsp;'}</div></div>`);
            }
        });

        // å¤„ç†å‰©ä½™ä¸Šä¸‹æ–‡
        if (this.foldContextEnabled && contextBuffer.length > foldThreshold && contextStart >= 0) {
            const contextId = `context-${contextStart}-${htmlLines.length - 1}`;
            const contextHtml = contextBuffer.map(l => {
                return `<div class="diff-line"><div class="diff-line-content">${l.html || '&nbsp;'}</div></div>`;
            }).join('');
            
            resultLines.push(
                `<div class="context-fold collapsed" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed')">
                    <span>â‹¯ ${contextBuffer.length} è¡Œæœªå˜æ›´å†…å®¹ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</span>
                </div>
                <div class="context-lines collapsed" id="${contextId}">${contextHtml}</div>`
            );
        } else if (contextBuffer.length > 0) {
            contextBuffer.forEach(l => {
                resultLines.push(`<div class="diff-line"><div class="diff-line-content">${l.html || '&nbsp;'}</div></div>`);
            });
        }

        this.dom.view.innerHTML = resultLines.join('') || '<div class="empty-tip">æ— å·®å¼‚</div>';
        this.currentChunkIdx = -1;
        
        // è®¡ç®—ä¿®æ”¹å‰åçš„å­—æ•°
        const oldChars = this.dom.old.value.length;
        const newChars = this.dom.new.value.length;
        const totalChanges = delChunks + insChunks;
        
        if (totalChanges === 0) {
            this.dom.stats.innerText = `âœ… æ–‡æœ¬å®Œå…¨ä¸€è‡´ (${oldChars.toLocaleString()} å­—)`;
        } else {
            const statsParts = [
                `${totalChanges} å¤„å˜æ›´`,
                `åˆ é™¤ ${delChunks} å¤„ (${delChars.toLocaleString()} å­—)`,
                `æ’å…¥ ${insChunks} å¤„ (${insChars.toLocaleString()} å­—)`,
                `ä¿®æ”¹å‰ ${oldChars.toLocaleString()} å­—`,
                `ä¿®æ”¹å ${newChars.toLocaleString()} å­—`
            ];
            this.dom.stats.innerText = statsParts.join(' | ');
        }
    },

    navDiff(dir) {
        if (!this.diffChunks.length) return;
        this.currentChunkIdx += dir;
        if (this.currentChunkIdx < 0) this.currentChunkIdx = this.diffChunks.length - 1;
        if (this.currentChunkIdx >= this.diffChunks.length) this.currentChunkIdx = 0;

        const el = document.getElementById(this.diffChunks[this.currentChunkIdx]);
        if (el) {
            document.querySelectorAll('.highlight-focus').forEach(e => e.classList.remove('highlight-focus'));
            el.classList.add('highlight-focus');
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
};

App.init();
</script>
</body>
</html>
